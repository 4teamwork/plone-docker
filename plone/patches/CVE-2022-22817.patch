CVE-2022-22817 PIL.ImageMath.eval allows evaluation of arbitrary expressions

--- a/Tests/test_imagemath.py
+++ b/Tests/test_imagemath.py
@@ -56,6 +56,12 @@
             pixel(ImageMath.eval("float(B)**33", images)), "F 8589934592.0"
         )
 
+    def test_prevent_exec(self):
+        self.assertRaises(ValueError, ImageMath.eval("exec('pass')"))
+        self.assertRaises(ValueError, ImageMath.eval("(lambda: exec('pass'))()"))
+        self.assertRaises(ValueError, ImageMath.eval("(lambda: (lambda: exec('pass'))())()"))
+
+
     def test_logical(self):
         self.assertEqual(pixel(ImageMath.eval("not A", images)), 0)
         self.assertEqual(pixel(ImageMath.eval("A and B", images)), "L 2")
--- a/src/PIL/ImageMath.py
+++ b/src/PIL/ImageMath.py
@@ -264,7 +264,18 @@
         if hasattr(v, "im"):
             args[k] = _Operand(v)
 
-    out = builtins.eval(expression, args)
+    compiled_code = compile(expression, "<string>", "eval")
+    def scan(code):
+        for const in code.co_consts:
+            if type(const) == type(compiled_code):
+                scan(const)
+
+        for name in code.co_names:
+            if name not in args and name != "abs":
+                raise ValueError(f"'{name}' not allowed")
+
+    scan(compiled_code)
+    out = builtins.eval(expression, {"__builtins": {"abs": abs}}, args)
     try:
         return out.im
     except AttributeError:
