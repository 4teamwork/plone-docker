CVE-2023-50447 python-pillow: pillow:Arbitrary Code Execution via the environment parameter

--- a/Tests/test_imagemath.py
+++ b/Tests/test_imagemath.py
@@ -61,6 +61,11 @@
         self.assertRaises(ValueError, ImageMath.eval("(lambda: exec('pass'))()"))
         self.assertRaises(ValueError, ImageMath.eval("(lambda: (lambda: exec('pass'))())()"))
 
+    def test_prevent_double_underscores(self):
+        self.assertRaises(ValueError, ImageMath.eval("1", {"__": None}))
+    
+    def test_prevent_builtins(self):
+        self.assertRaises(ValueError, ImageMath.eval("(lambda: exec('exit()'))()", {"exec": None}))
 
     def test_logical(self):
         self.assertEqual(pixel(ImageMath.eval("not A", images)), 0)
--- a/src/PIL/ImageMath.py
+++ b/src/PIL/ImageMath.py
@@ -258,6 +258,11 @@
 
     # build execution namespace
     args = ops.copy()
+    for k in list(_dict.keys()) + list(kw.keys()):
+        if "__" in k or hasattr(builtins, k):
+            msg = f"'{k}' not allowed"
+            raise ValueError(msg)
+
     args.update(_dict)
     args.update(kw)
     for k, v in list(args.items()):
